# ============================================================================
# Docker Compose — Local Development & Testing
# ============================================================================
# Usage:
#   docker compose up              → Start the platform API
#   docker compose up --build      → Rebuild and start
#   docker compose --profile dev up → Start with hot-reload
#   docker compose down            → Stop everything
# ============================================================================

services:
  # ── Production-like container ──────────────────────────────────────────────
  platform-api:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        VERSION: "1.0.0"
        BUILD_TIME: "${BUILD_TIME:-unknown}"
        COMMIT_SHA: "${COMMIT_SHA:-unknown}"
    container_name: platform-api
    ports:
      - "9090:9090"
    environment:
      - ENVIRONMENT=production
      - LOG_LEVEL=info
      - PORT=9090
      - SERVICE_NAME=platform-api
      - SERVICE_VERSION=1.0.0
    restart: unless-stopped
    read_only: true
    security_opt:
      - no-new-privileges:true
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/healthz"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    deploy:
      resources:
        limits:
          cpus: "0.50"
          memory: 128M
        reservations:
          cpus: "0.10"
          memory: 32M

  # ── Development container with hot-reload ──────────────────────────────────
  platform-api-dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.dev
    container_name: platform-api-dev
    ports:
      - "9090:9090"
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=debug
      - PORT=9090
    volumes:
      - ../app:/app
    profiles:
      - dev
